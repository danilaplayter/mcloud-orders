server:
  port: 9090

spring:
  application:
    name: mcloud-orders

  datasource:
    url: jdbc:postgresql://localhost:5432/orders
    username: orders
    password: secret
    driver-class-name: org.postgresql.Driver

  liquibase:
    change-log: classpath:liquibase/changelog-master.yml
    enabled: true

  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        use_sql_comments: true
    database-platform: org.hibernate.dialect.PostgreSQLDialect

  kafka:
    bootstrap-servers: localhost:9092

    consumer:
      group-id: mcloud-orders-consumer
      auto-offset-reset: earliest
      enable-auto-commit: false
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.ErrorHandlingDeserializer
      properties:
        spring.json.trusted.packages: "ru.mentee.power.orders.*"
        spring.json.type.mapping: "orderEvent:ru.mentee.power.orders.adapters.kafka.OrderEventPayload"
        max.poll.records: 5
        max.poll.interval.ms: 300000
        session.timeout.ms: 10000
        heartbeat.interval.ms: 3000
        isolation.level: read_committed

      listener:
        pause-immediately: false
        missing-topics-fatal: false
        ack-mode: manual_immediate

    # Добавьте producer конфигурацию
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      properties:
        spring.json.type.mapping: "orderEvent:ru.mentee.power.orders.adapters.kafka.OrderEventPayload,deadLetterMessage:ru.mentee.power.orders.domain.model.DeadLetterMessage"
        acks: all
        retries: 3
        enable.idempotence: true
        delivery.timeout.ms: 120000
        request.timeout.ms: 30000

kafka:
  topics:
    orders:
      priority:
        high: orders.priority.high
        normal: orders.priority.normal
        low: orders.priority.low
    # Добавьте DLQ тему
    dlq: orders.priority.dlq

resilience4j:
  retry:
    configs:
      default:
        max-attempts: 3
        wait-duration: 500ms
        retry-exceptions:
          - org.springframework.dao.DataAccessException
          - org.springframework.orm.jpa.JpaSystemException
          - jakarta.persistence.OptimisticLockException
          - java.sql.SQLException
          - org.springframework.kafka.KafkaException
          - org.apache.kafka.common.errors.TimeoutException
          - org.apache.kafka.common.errors.NetworkException
        ignore-exceptions:
          - jakarta.validation.ConstraintViolationException
          - org.springframework.web.bind.MethodArgumentNotValidException
          - java.lang.IllegalArgumentException
    instances:
      order-processing:
        base-config: default
        wait-duration: 500ms
        max-attempts: 3
        retry-exceptions:
          - org.springframework.dao.DataAccessException
          - java.sql.SQLException
          - jakarta.persistence.OptimisticLockException
          - org.springframework.orm.ObjectOptimisticLockingFailureException
      kafka-consumer-retry:
        base-config: default
        wait-duration: 1s
        max-attempts: 5
        retry-exceptions:
          - org.springframework.kafka.KafkaException
          - org.apache.kafka.common.errors.TimeoutException
          - org.apache.kafka.common.errors.NetworkException

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: always
      show-components: always
  health:
    probes:
      enabled: true

logging:
  level:
    ru.mentee.power.orders: INFO
    ru.mentee.power.orders.adapters.kafka: DEBUG
    ru.mentee.power.orders.domain.usecase: DEBUG
    org.springframework.kafka: INFO
    org.apache.kafka: WARN
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE